"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9889],{3905:function(e,t,r){r.d(t,{Zo:function(){return p},kt:function(){return d}});var n=r(7294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(r),d=o,m=u["".concat(s,".").concat(d)]||u[d]||h[d]||a;return r?n.createElement(m,i(i({ref:t},p),{},{components:r})):n.createElement(m,i({ref:t},p))}));function d(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var c=2;c<a;c++)i[c]=r[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}u.displayName="MDXCreateElement"},724:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return p},default:function(){return u}});var n=r(7462),o=r(3366),a=(r(7294),r(3905)),i=["components"],l={title:"2021-08-13 - Blank Screen because of incompatible Local Storage Schema"},s=void 0,c={unversionedId:"incident-reports/2021-08-13-localstorage-schema-error",id:"incident-reports/2021-08-13-localstorage-schema-error",isDocsHomePage:!1,title:"2021-08-13 - Blank Screen because of incompatible Local Storage Schema",description:"Date: 13 August, 2021",source:"@site/docs/incident-reports/2021-08-13-localstorage-schema-error.md",sourceDirName:"incident-reports",slug:"/incident-reports/2021-08-13-localstorage-schema-error",permalink:"/incident-reports/2021-08-13-localstorage-schema-error",editUrl:"https://github.com/felvin-search/docs/edit/master/docs/incident-reports/2021-08-13-localstorage-schema-error.md",tags:[],version:"current",frontMatter:{title:"2021-08-13 - Blank Screen because of incompatible Local Storage Schema"},sidebar:"mySidebar",previous:{title:"Deployment runbook",permalink:"/team-docs/felvin.com/deployment-runbook"}},p=[{value:"What was the problem?",id:"what-was-the-problem",children:[]},{value:"Why did it happen?",id:"why-did-it-happen",children:[]},{value:"How did we fix it?",id:"how-did-we-fix-it",children:[]},{value:"Lessons and thoughts",id:"lessons-and-thoughts",children:[]}],h={toc:p};function u(e){var t=e.components,r=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,n.Z)({},h,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Date: 13 August, 2021")),(0,a.kt)("h2",{id:"what-was-the-problem"},"What was the problem?"),(0,a.kt)("p",null,"A user who has not opened for long ago, reopened the website and noticed a blank screen with the following errors in the console."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/0Zo9Com.png",alt:"Error in console"})),(0,a.kt)("h2",{id:"why-did-it-happen"},"Why did it happen?"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/Neera-AI/neera/commit/bf53ca0bf9ec97809dde5694541f4c9b1ee0b417"},"Till mid May 2021"),", we used to store ",(0,a.kt)("inlineCode",{parentName:"p"},"profile")," in the local storage with schema ",(0,a.kt)("inlineCode",{parentName:"p"},"[<profile 1>, <profile 2>]"),". Then we removed using local storage and fetched all the profiles from DB. Though profiles didn't change often, so optimize website load time with ",(0,a.kt)("a",{parentName:"p",href:"https://blog.neera.ai/2021/07/22/v1-27-0-autocorrect-faster-results-and-a-basic-image-search/"},"v1.27.0")," we re-introduced local storage. This time the schema was different and looked like ",(0,a.kt)("inlineCode",{parentName:"p"},"{list:[<profile 1>, <profile 2>]}"),"."),(0,a.kt)("p",null,"If a person had Local Storage schema stored as per old schema, and then they open it now, it would cause error as the latest code expects a different Schema. This precisely happened with one of the users. The user had opened the site once long back, and never used the site later. But when the user was trying to access the site recently, an error triggered preventing the page from loading."),(0,a.kt)("h2",{id:"how-did-we-fix-it"},"How did we fix it?"),(0,a.kt)("p",null,"We changed the key name of the profiles from ",(0,a.kt)("inlineCode",{parentName:"p"},"profile")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"profile_v2021_08_13"),". When a user opens a page, it tries to find profiles from the Local Storage with the new key name - ",(0,a.kt)("inlineCode",{parentName:"p"},"profile_v2021_08_13"),", since it doesn't exist in any of the users till now. It will fetch the profiles from database as per the latest schema and the latest schema will be used by all the users from now on, irrespective of when they had opened our site in the past."),(0,a.kt)("p",null,"The date was included in the key name so that it is easier to recollect an explanation for the change. It will be easier to identify schema of the value as per versions in future. Hence, we can avoid the problem of having different data schemas for same key name."),(0,a.kt)("h2",{id:"lessons-and-thoughts"},"Lessons and thoughts"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Cookies are better because, one can set an expiry date and new ones can be used."),(0,a.kt)("li",{parentName:"ul"},"Do not rely on Local Storage heavily. It's difficult to change the values. Sometimes to fix the bugs, you may have to do dirty hacks, which compromise code quality.")),(0,a.kt)("p",null,"The other ideas that were suggested to solve the problem"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Catch errors while using values fetched from localstorage")," In ",(0,a.kt)("inlineCode",{parentName:"li"},"useEffect")," fetching the profile value, check if the current data schema is the latest one. If not, remove the key-value from Local Storage and re-fetch from the Database. We have a simpler solution than this."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Kill Local Storage:")," Remove Local Storage completely. Using Local Storage, the performance increase is apparent, this issue could be fixed with simpler solution without compromising on performance.")))}u.isMDXComponent=!0}}]);