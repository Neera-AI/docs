"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[668],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return c}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=p(n),c=r,m=d["".concat(l,".").concat(c)]||d[c]||h[c]||o;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1759:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return u},default:function(){return d}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={title:"Supertokens for user authentication"},l=void 0,p={unversionedId:"decisions/supertokens_for_auth",id:"decisions/supertokens_for_auth",isDocsHomePage:!1,title:"Supertokens for user authentication",description:"Decision",source:"@site/docs/decisions/supertokens_for_auth.md",sourceDirName:"decisions",slug:"/decisions/supertokens_for_auth",permalink:"/decisions/supertokens_for_auth",editUrl:"https://github.com/felvin-search/docs/edit/master/docs/decisions/supertokens_for_auth.md",tags:[],version:"current",frontMatter:{title:"Supertokens for user authentication"},sidebar:"mySidebar",previous:{title:"Public Engineering Documentation",permalink:"/decisions/public_documentation"},next:{title:"Styled components",permalink:"/decisions/styled_components_for_css"}},u=[{value:"Decision",id:"decision",children:[]},{value:"Date",id:"date",children:[]},{value:"Context",id:"context",children:[]},{value:"Factors",id:"factors",children:[]},{value:"Alternatives",id:"alternatives",children:[]},{value:"Expected Outcome",id:"expected-outcome",children:[]},{value:"Actual Outcome",id:"actual-outcome",children:[{value:"1 month review",id:"1-month-review",children:[]},{value:"6 month review",id:"6-month-review",children:[]},{value:"2 year review",id:"2-year-review",children:[]},{value:"5 year review",id:"5-year-review",children:[]}]}],h={toc:u};function d(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"decision"},"Decision"),(0,o.kt)("p",null,"We will use Supertokens as our third party authentication tool."),(0,o.kt)("h2",{id:"date"},"Date"),(0,o.kt)("p",null,"14th May 2021"),(0,o.kt)("h2",{id:"context"},"Context"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"We needed to add user authentication so that users can save changes to their search profiles."),(0,o.kt)("li",{parentName:"ul"},"I ","(","Harsh",")"," have implemented Auth before at Project Mojo and we know that auth is tricky. It doesn't make sense to write your own auth.")),(0,o.kt)("h2",{id:"factors"},"Factors"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Stability: The third party system shouldn't break randomly."),(0,o.kt)("li",{parentName:"ul"},"Ease of Use: If we are using a third party tool, it should actually make our job easy."),(0,o.kt)("li",{parentName:"ul"},"Are there Vendor Lock In: We should be able to move away from a tool if it is not working for us anymore.")),(0,o.kt)("p",null,"Why Supertokens"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Most important factor: We don't have vendor lockin with them."),(0,o.kt)("li",{parentName:"ul"},"They are open source and we can always choose to run supertokens on our hosted instance."),(0,o.kt)("li",{parentName:"ul"},"They are very new, so they score low on ease of use and stability. Though the founders are very active and very supportive in helping us use Supertokens, so that makes up.")),(0,o.kt)("h2",{id:"alternatives"},"Alternatives"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Auth0"),(0,o.kt)("li",{parentName:"ul"},"AWS Cognito"),(0,o.kt)("li",{parentName:"ul"},"Firebase Auth")),(0,o.kt)("h2",{id:"expected-outcome"},"Expected Outcome"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"We shoudln't have to implement auth over and over. We won't see the impact of lack of vendor lock in anytime soon. Maybe we won't see it at all, though its a super important factor. When things like vendor lock in hits you, it hits you hard. Say 3 years down the line if Auth0 decides to do something stupid, like heavily increase the pricing, we'll have an easy way to move away. Such things can be real bad.")),(0,o.kt)("h2",{id:"actual-outcome"},"Actual Outcome"),(0,o.kt)("p",null,"To be seen"),(0,o.kt)("h3",{id:"1-month-review"},"1 month review"),(0,o.kt)("p",null,"The move to Supertokens has been pretty positive till now. There were numerous times we faced issues/bugs which were promptly addressed and fixed after discussions on Supertokens discord."),(0,o.kt)("p",null,"The following are the issues we discussed on their discord server and how they were solved."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Endless refresh tokens being sent ","(","17/5/2021",")"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"Due to some reason, a lot of requests to refresh tokens was being sent to ",(0,o.kt)("inlineCode",{parentName:"p"},"/refresh")),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"This problem was due to cookies not being set in the frontend, which in turn resulted in these endless refresh tokens requests. The main reason why the cookies weren't getting set was because all the requests were going to ",(0,o.kt)("inlineCode",{parentName:"p"},"neera.ai/auth")," which should have been going to ",(0,o.kt)("inlineCode",{parentName:"p"},"neera.ai/api/auth"),"."),(0,o.kt)("p",{parentName:"li"},"This was fixed by adding ",(0,o.kt)("inlineCode",{parentName:"p"},"/api/auth")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"apiBasePath")," in both Frontend and Backend.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Having multiple domains ","(","not sub-domains",")"," as the ",(0,o.kt)("inlineCode",{parentName:"p"},"websiteDomain")," ","(","21/5/2021",")"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"In an attempt to have login and signups on other domains than production, there was the need of enabling Supertokens on netlify deploy previews as well as ",(0,o.kt)("inlineCode",{parentName:"p"},"beta.neera.ai"),". The issue being, that while one can allow the deploy previews, by using a RegEx, and beta.neera.ai through CORS using an array. One cannot do the same in Supertokens init."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"A solution of access the deploy preview domain using Netlify in built environment variables was suggested by the adming on the discord server. This was suggested as one couldn't pass a RegEx. This proved to rather tricky and not worth the effort that had to be put in or had already been put in."),(0,o.kt)("p",{parentName:"li"},"We later changed the ",(0,o.kt)("inlineCode",{parentName:"p"},"websiteDomain")," based on the ",(0,o.kt)("inlineCode",{parentName:"p"},"process.env")," for ",(0,o.kt)("inlineCode",{parentName:"p"},"beta.neera.ai"),", this resulted in us being able to use things like sign up and sign in on both the production as well as the beta version. We decided on keeping the Netlify deploy previews only to check changes in UI.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Connecting to Supertokens DB ","(","1/6/2021",")"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"While trying to make a CSV with the emails of all the users who had signed up on Neera we realized how we only store the userId, which is a random string generated by Supertokens, in our main DB. The emails themselves are stored directly on Supertokens DB but there wasn't any mention on how to connect to that DB and dump all the data into a CSV in their documentation. Nor was there any similar option on their dashboard."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"One doesn't have to host Supertokens and can use it directly out of the box for free, till they have less than 5000 registered users. This is called the managed service. There is also the option of paying them for using the managed service once we cross that number or hosting Supertokens on a server of our own and using it for free."),(0,o.kt)("p",{parentName:"li"},"It turned out that till one is using the managed service, they cannot connect to the Supertokens Database storing the data. This was solved by Supertokens team by giving the option of downloading the CSV on their dashboard. After they confirmed that a CSV would fulfill our needs, the released the feature in 2 days!")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Supertokens Cookies not getting attached to pocket and notion requests"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"In order to store the access tokens of specific users in the main database, we had to indetify the userId of the user in the backend. This can be easily done as Supertokens attaches cookies to all the requests from frontend to backend. But for some reason, they weren't getting attached to any requests written for the plugins."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"We weren't able to figure out why exactly this was happening, as there were numerous reasons this could have happened. While writing code to send userId from the frontend itself, the cookies started getting sent with the requests.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"1Password not working on Sign Up page ","(","21/6/2021",")"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"During the meeting with KK we saw how 1Password wasn't working, which is something he heavily depends on for managing his passwords."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"This was said to be due to use of ShadowDOM, which has been disabled while styling the sign up page. ",(0,o.kt)("strong",{parentName:"p"},"Still needs to checked whether the issue is fixed or not"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Overriding components in Sign up page ","(","1/7/2021",")"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"The custom styling wasn't getting applied to the signup form."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"The issue got fixed by updating to a newer version of ",(0,o.kt)("inlineCode",{parentName:"p"},"supertokens-auth-react"),". This also led to finding a bug in their new version, which prevented us to have an empty providers array in our ",(0,o.kt)("inlineCode",{parentName:"p"},"init()")," function. I temporarily fixed it by GitHub, and removed it after a new release was made a few hours later.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Default scope not getting overwritten after providing other scope for in built provider ","(","9/7/2021",")"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Issue")),(0,o.kt)("p",{parentName:"li"},"By default the GitHub sign up asks for the ",(0,o.kt)("inlineCode",{parentName:"p"},"user")," scope, which also asks for write access to personal information on GitHub. This is unnecessary for a simple OAuth and may prevent people from signing up with GitHub."),(0,o.kt)("p",{parentName:"li"},"Even after specifing other scopes, the default scope remained ",(0,o.kt)("inlineCode",{parentName:"p"},"user"),"."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Solution")),(0,o.kt)("p",{parentName:"li"},"This is an ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/supertokens/supertokens-node/issues/148"},"open issue on supertokens"),", they are going to fix this in the next release but till then we can make a custom GitHub provider, the code for the same has been provided on their discord server."))),(0,o.kt)("h3",{id:"6-month-review"},"6 month review"),(0,o.kt)("h3",{id:"2-year-review"},"2 year review"),(0,o.kt)("h3",{id:"5-year-review"},"5 year review"))}d.isMDXComponent=!0}}]);