"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5906],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),d=i,m=u["".concat(l,".").concat(d)]||u[d]||h[d]||r;return n?a.createElement(m,o(o({ref:t},c),{},{components:n})):a.createElement(m,o({ref:t},c))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},5924:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return c},default:function(){return u}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],s={},l="Adding a Plugin to Felvin",p={unversionedId:"unpublished/troubleshooting-and-how-tos/adding-plugin",id:"unpublished/troubleshooting-and-how-tos/adding-plugin",isDocsHomePage:!1,title:"Adding a Plugin to Felvin",description:"This document explains how to add a third-party app search plugin like Pocket, Notion to Felvin Search. This enables users to search documents present in these apps directly via Felvin. For every plugin, a new Github Repository must be made. Once you have decided on the app, whose search you want to include follow these steps",source:"@site/docs/unpublished/troubleshooting-and-how-tos/adding-plugin.md",sourceDirName:"unpublished/troubleshooting-and-how-tos",slug:"/unpublished/troubleshooting-and-how-tos/adding-plugin",permalink:"/unpublished/troubleshooting-and-how-tos/adding-plugin",editUrl:"https://github.com/felvin-search/docs/edit/master/docs/unpublished/troubleshooting-and-how-tos/adding-plugin.md",tags:[],version:"current",frontMatter:{}},c=[{value:"Logistical Guidelines:",id:"logistical-guidelines",children:[]},{value:"Technical Guidelines:",id:"technical-guidelines",children:[]}],h={toc:c};function u(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"adding-a-plugin-to-felvin"},"Adding a Plugin to Felvin"),(0,r.kt)("p",null,"This document explains how to add a third-party app search plugin like Pocket, Notion to Felvin Search. This enables users to search documents present in these apps directly via Felvin. For every plugin, a new Github Repository must be made. Once you have decided on the app, whose search you want to include follow these steps"),(0,r.kt)("h1",{id:"1-implementing-oauth"},"1. Implementing OAuth"),(0,r.kt)("h2",{id:"logistical-guidelines"},"Logistical Guidelines:"),(0,r.kt)("p",null,"Since to access the documents authentication is required, you need to include the app's OAuth in Felvin. There are 2 ways to include the app's OAuth in Felvin"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Use a Library"),": There are some libraries which provide a OAuth for a large number of parties(",(0,r.kt)("a",{parentName:"p",href:"https://github.com/simov/grant#callback-session"},"ref"),") or sometime you can find app-specific OAuth libraries(",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/googleapis"},"ref"),"). Such libraries if properly implemented complete the job in few lines of code."),(0,r.kt)("p",{parentName:"li"},"  But sometimes these libraries, like ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/simov/grant#callback-session"},"this")," one, are not suitable for architecture where frontend and backend are decoupled, like in our case. They work well when Server-side code also has the job of service frontend pages, like in the case of Flask with Jinja templates. Instead of trying hacks to complete the job with hacks, it is better to look for an alternative.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Implement OAuth from Scratch"),": If you have a basic understanding of OAuth Protocol, implementing OAuth from Scratch is not a scary thing as it sounds. Almost all parties follow the ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749"},"standard OAuth")," flow. Few follow a variant of the standard, that too with minor changes."),(0,r.kt)("p",{parentName:"li"},"  The advantage here is that you have control over every step. You can design the flow as your requirements. You will have better clarity on the flow of requests especially in a situation like Felvin, where there are 2 backends - plugin, Felvin Backend."),(0,r.kt)("p",{parentName:"li"},"  But if implementing from scratch is too complicated, and there is a neat alternative library using a library can be more beneficial. For example, Google's OAuth flow is too complicated and there is an official OAuth library by Google to simplify the job. Hence, the Google drive plugin was written using the official ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/googleapis"},"googleapis npm")," library."),(0,r.kt)("p",{parentName:"li"},"  ",(0,r.kt)("strong",{parentName:"p"},"Some important points to be kept in mind. The following points assume that you have a basic understanding of OAuth. If not, watch this short ",(0,r.kt)("a",{parentName:"strong",href:"https://youtu.be/CPbvxxslDTU"},"YouTube video"),":")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Each app gives you a Client ID and a Client Secret. While Client ID is required on the frontend, for the user to give Felvin access, ",(0,r.kt)("strong",{parentName:"p"},"Client Secret should not be exposed in any case"),". If someone has both Felvin integrations Client ID and Client Secrets, they can do things like sending too many improper requests, which can lead to our integration getting banned."),(0,r.kt)("p",{parentName:"li"},"  Hence, requests involving Client Secret should be made from plugin only rather than the frontend.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Change Redirect URIs accordingly when the app's search service is in production. For most of the apps, the Redirect URI needs to be changed at 2 places - in the code, settings of the app."))))),(0,r.kt)("h2",{id:"technical-guidelines"},"Technical Guidelines:"),(0,r.kt)("p",null,"Here is the flow of a third party app's service "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"User selects the tab, say notion, which he/she wants to search")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Once the user enters the search query, Frontend checks if the app's access token is present in browser's localstorage or not."),(0,r.kt)("p",{parentName:"li"},"   Tokens are stored in the browser in the following format"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},'{\n   "tokens":{\n      "app_name1":{\n         "access_token":"string"\n      },\n      "app_name2":{\n         "access_token":"string"\n      }\n   }\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"If the relevant app's access token is not found in localStorage, the frontend makes a request to Felvin Backend to check if the app's access token is present in DB.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Felvin Backend returns a JSON of the same above format, saved in the ",(0,r.kt)("inlineCode",{parentName:"p"},"access_tokens")," column. The frontend saves the JSON in localStorage and checks if the app's access token is present or not. (Note that only strings can be saved in localStorage. Hence the JSON is stringified using ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON.stringfy")," before saving in localStorage. And while accessing the tokens, it is parsed using ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON.parse"),")")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"If the access token is access token is still not found, it means the user has not yet completed OAuth with the app.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The following are the steps for the user to complete OAuth. Note the process can differ based on the application. But the steps on the user's side will almost always remain same"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"User clicks on the button ",(0,r.kt)("inlineCode",{parentName:"p"},"Sign In with the APP_NAME"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"On clicking the button, the page redirects to the app's page. The user is asked to give access to Felvin's integration.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Once the user gives access, the page is redirected to the Redirect URI, registered in the app's settings and in the code.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"As per standard OAuth, the Redirect URI contains a ",(0,r.kt)("inlineCode",{parentName:"p"},"code")," in query parameters.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The callback component(the component at Redirect URI) in the frontend sends the ",(0,r.kt)("inlineCode",{parentName:"p"},"code")," to the plugin service.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The plugin service sends the ",(0,r.kt)("inlineCode",{parentName:"p"},"code")," to the app's relevant OAuth API and receives the ",(0,r.kt)("inlineCode",{parentName:"p"},"access token"),". This ",(0,r.kt)("inlineCode",{parentName:"p"},"access token")," is used to access the user's documents in the app.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The plugin service sends ",(0,r.kt)("inlineCode",{parentName:"p"},"access token")," to the Frontend.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Frontend saves the ",(0,r.kt)("inlineCode",{parentName:"p"},"access token")," in its localStorage and sends it Felvin Backend to update the ",(0,r.kt)("inlineCode",{parentName:"p"},"access token")," in the Felvin DB."),(0,r.kt)("h1",{parentName:"li",id:"2-searching-the-documents"},"2. Searching the documents"),(0,r.kt)("p",{parentName:"li"},"There are 2 ways to implement search."))),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Using the app's Search APIs:")," This is preferred if"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"the Rate Limit of the API is not too strict")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"the search results provided by API are good."),(0,r.kt)("p",{parentName:"li"},"A request can be made directly from the frontend or via the plugin service to the app's search API. ")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Using Meili Search:")," A Meili Search DB is connected to a plugin service. The app's documents are stored in Meili Search DB. The documents can be indexed via the user's access token."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"So when a user enters the query, the access token is sent to the plugin service. The plugin service returns the search results via Meili Search library APIs.\n\nNote that the documents in Meili Search DB need to be updated. To achieve that, a cronjob can be set up, which fetches the latest documents of all users using the access tokens. \n\nTo setup a cronjob:\n\n- Write an endpoint on the plugin service, which when hit, updates documents of all the users in Meili Search DB. (Ex: `/cronjob` endpoint in [this](https://github.com/felvin-search/pocket-search-api/blob/master/server/server.js) file)\n- Make a request to the endpoint periodically via Github Actions. ([Example](https://github.com/felvin-search/pocket-search-api/blob/master/.github/workflows/cronjob.yml))\n\nThrough this, cronjob can be monitored via the web, instead of having to check the server. Also make sure that you don't expose the DB. The DB must be accessed only by the plugin service.\n")),(0,r.kt)("h1",{parentName:"li",id:"adding-docs"},"Adding Docs"),(0,r.kt)("p",{parentName:"li"},"Once everything is working well, add the following in the README of the repo ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Endpoints documentation - For each endpoint mention the HTTP method, data to be sent, response format.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Auth flow - explaining how a user completes OAuth")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Search flow - Explaining how search results are obtained - via the app's search API or Meili Search. If Meili Search is used, explain how the cronjob is set up. Link necessary files for clarity."))))))}u.isMDXComponent=!0}}]);